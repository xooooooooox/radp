stages:
  - prepare
  - release

prepare_environment:
  stage: prepare
  tags:
    - ubuntu-shell
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - ".github/**"
        - ".gitlab/**"
        - "Writerside/**"
        - ".mvn/**"
        - "**/*.md"
        - "*.yml"
      when: never
  script:
    - |
      if ! command -v vfox >/dev/null 2>&1;then
        exit 1
      fi
      eval "$(vfox activate bash)" || true
      if ! command -v java >/dev/null 2>&1;then
        vfox add java || true
        vfox install java@v8.0.342+7-tem || true
        vfox use -g java@8.0.432+6-tem || true
        java -version || exit 1
      fi
      if ! command -v mvn >/dev/null 2>&1;then
        vfox add maven || true
        vfox install maven@3.9.9 || true
        vfox use -g maven@3.9.9 || true
        mvn -v || exit 1
      fi

release:
  stage: release
  tags:
    - ubuntu-shell
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - ".github/**"
        - ".gitlab/**"
        - "Writerside/**"
        - ".mvn/**"
        - "**/*.md"
        - "*.yml"
      when: never
  script:
    - |
      pwd
      [[ ! -x mvnw ]] && chmod +x mvnw
      ./mvnw clean deploy -Pcoding,publish-artifactory \
        --settings .mvn/settings.xml \
        -DskipTests \
        -Dauto.release.enabled=false -Dauto.archetype.catalog.minio=false