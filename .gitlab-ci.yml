############################################## inputs ##################################################################
spec:
  inputs:
    environment:
      type: string
      options: [ '', 'dev', 'sit', 'uat', 'prod', 'local' ]
      default: ''
    version_type:
      description: '指定版本号自动计算规则(如指定 minor,则默认 minor+1)'
      type: string
      options: [ 'patch', 'minor', 'major' ]
      default: 'minor'
    runner_tags:
      description: 'All jobs default runner tags'
      options: [ 'k8s', 'shell', 'docker', 'ubuntu-shell', 'centos-shell', 'ubuntu-docker' ]
      default: 'k8s'

---
############################################## includes ################################################################
include:
  - project: homelab/gitlab-ci-templates
    ref: main
    file: templates/k8s/pipelines/lang/java.yml
    inputs:
      environment: $[[ inputs.environment ]]
      version_type: $[[ inputs.version_type ]]
      runner_tags: $[[ inputs.runner_tags ]]


############################################## variables ###############################################################
variables:
  TP_RUN_LINT: "true"         # [2] 是否启用代码评审阶段
  TP_RUN_UNIT_TEST: "true"    # [3] 是否启用单元测试阶段
  TP_RUN_SONARQUBE: "true"    # [4] 是否启用质量门阶段
  TP_RUN_BUILD: "false"       # [5] 是否启用构建阶段
  TP_RUN_PACKAGE: "false"     # [6] 是否启用打包阶段
  TP_RUN_PUBLISH: "true"      # [7] 是否启用制品发布阶段
  TP_RUN_PAGES: "true"        # [8] 是否启用pages阶段
  TP_RUN_DEPLOY: "false"      # [9] 是否启用部署阶段

  TP_BASE_IMAGE: maven:3.9.9-eclipse-temurin-8
  TP_CODE_REVIEW_BRANCHES: "$DF_CODE_REVIEW_BRANCHES"
  ## ------------------------------------------- [1] prepare args -----------------------------------------------------#
  # TP_TAG_NAME: 指定要创建的标签名称, 如果未指定, 将自动计算下一个版本号
  TP_CHILD_PIPELINE_TEMPLATE_REF: main
  TP_PREPARE_SCRIPT_REF: $TP_CHILD_PIPELINE_TEMPLATE_REF  # 可选：指定使用哪个分支的脚本，如果未指定，将尝试获取最新的tag，如果没有tag则使用main

  ## ------------------------------------------- [2] lint args --------------------------------------------------------#
  TP_LINT_IMAGE: $TP_BASE_IMAGE
  TP_LINT_SHELL: "$DF_LINT_BASE_SHELL --settings .mvn/settings.xml -Pcoding,code-review,repo-artifactory"

  ## ------------------------------------------- [3] unit-test args ---------------------------------------------------#
  TP_UNIT_TEST_IMAGE: $TP_BASE_IMAGE
  TP_UNIT_TEST_SHELL: "$DF_UNIT_TEST_BASE_SHELL jacoco:report-aggregate -ntp --settings .mvn/settings.xml \
                -Pcoding,unit-test,env-test,repo-artifactory \
                -Dapp.server.port=0 \
                -Dapp.management.server.port=0" # 如果是多模块项目在 TP_TEST_SHELL 中加上 jacoco:report-aggregate

  ## ------------------------------------------- [4] sonarqube args ---------------------------------------------------#
  TP_SONARQUBE_IMAGE: $DF_SONARQUBE_IMAGE
  TP_SONARQUBE_CHECK_SHELL: "$DF_SONARQUBE_BASE_SHELL -ntp --settings .mvn/settings.xml -Pcoding,code-review,repo-artifactory"
  TP_SONARQUBE_USER_HOME: "$DF_SONAR_USER_HOME"

  ## ------------------------------------------- [5] build args -------------------------------------------------------#
  TP_BUILD_IMAGE: $TP_BASE_IMAGE
  TP_BUILD_ARTIFACT_PATH: ""
  TP_BUILD_SHELL: "$DF_BUILD_BASE_SHELL --settings .mvn/settings.xml -Pcoding,repo-artifactory"

  ## ------------------------------------------- [6] package args -------------------------------------------------------#
  TP_PACKAGE_IMAGE: $TP_BASE_IMAGE
  TP_PACKAGE_ARTIFACT_PATH: "$DF_PACKAGE_ARTIFACT_PATH"
  TP_PACKAGE_SHELL: "$DF_PACKAGE_BASE_SHELL --settings .mvn/settings.xml -Pcoding,env-$TP_RUNTIME_ENV,o-tar,repo-artifactory"

  ## ------------------------------------------- [7] publish args -----------------------------------------------------#
  TP_PUBLISH_TYPE: maven
  TP_PUBLISH_BY_MAVEN_IMAGE: $TP_BASE_IMAGE
  TP_PUBLISH_BY_MAVEN_SHELL: "$DF_PUBLISH_BY_MAVEN_BASE_SHELL \
                            -Pcoding,publish-artifactory,env-$TP_RUNTIME_ENV,repo-artifactory \
                            -DskipTests \
                            -Dauto.release.enabled=false \
                            -Dauto.archtype.catalog.minio=false"

  ## ------------------------------------------- [8] pages args -------------------------------------------------------#
  TP_PAGES_TYPE: "writerside"
  TP_WRITERSIDE_INSTANCE: "Writerside/radp"
