# 取 XFF 第一跳
# 用正则从 X-Forwarded-For 里取最左边的一个 IP（遇到逗号/空格截止）。
# 即："1.2.3.4, 10.0.0.10" 会得到 1.2.3.4
# 如果请求里没有 X-Forwarded-For，结果置空
map $http_x_forwarded_for $xff_first {
    "~^ *([^, ]+)" $1;
    default "";
}

# 存在性标记
# 1) 有 PROXY protocol 地址 → pp_present="pp"
# 2) 有 XFF 第一个地址 → xff_present="xff"
# 3) 有 X-Real-IP → xri_present="xri"
map $proxy_protocol_addr  $pp_present  { "~.+" "pp";  default ""; }
map $xff_first            $xff_present { "~.+" "xff"; default ""; }
map $http_x_real_ip       $xri_present { "~.+" "xri"; default ""; }

# 决出“胜者 IP / 端口”
# 1) 从四个候选里取第一个非空的作为 $client_ip
map "$proxy_protocol_addr|$xff_first|$http_x_real_ip|$remote_addr" $client_ip {
    "~^\|*([^|]+)" $1;
}
# 2) 端口同理：优先用 proxy_protocol_port，否则用 remote_port。
map "$proxy_protocol_port|$remote_port" $client_port {
    "~^\|*([^|]+)" $1;
}

# 给"胜者"打来源标签
# 来源标签（pp > xff > xri > remote_addr）
map "$pp_present$xff_present$xri_present" $client_ip_src {
    "~^pp"   "proxy_protocol";
    "~^xff"  "x-forwarded-for";
    "~^xri"  "x-real-ip";
    default  "remote_addr";
}

# 请求ID优先级：X-Request-Id > $request_id
# 如果客户端/上游传了 X-Request-Id，就用它；否则用 NGINX 自己的 $request_id
map $http_x_request_id $req_id {
    "~.+"   $http_x_request_id;
    default $request_id;
}
